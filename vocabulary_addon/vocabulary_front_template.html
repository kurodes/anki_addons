<div id="word" style="margin-bottom: 30px; text-align: center">{{Front}}</div>
<!-- AI generated example sentences -->
<div id="sentences" style="margin-bottom: 30px; text-align: center"></div>
<div style="text-align: center">
  <button id="button" style="width: 80vw; height: 50px">
    Show Translation
  </button>
</div>

<script>
  async function getCompletionFromMessage(messages) {
    const LLM_KEY = "sk-";
    const LLM_URL =
      "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";
    const LLM_MODEL = "qwen-plus";
    // const LLM_KEY = "sk-proj-";
    // const LLM_URL = "https://api.openai.com/v1/chat/completions";
    // const LLM_MODEL = "gpt-5-mini";
    const response = await fetch(LLM_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${LLM_KEY}`,
      },
      body: JSON.stringify({
        model: LLM_MODEL,
        messages: messages,
      }),
    });
    if (response.status !== 200) {
      return "error";
    }
    const data = await response.json();
    return data.choices[0].message.content;
  }

  async function main() {
    let word = "{{Front}}";
    let prompt;
    let messages = [];
    let response;

    prompt = `
You are an English vocabulary assistant. Please generate example sentences for the word "${word}" following these strict rules:

1. **Polysemy Check**: If the word has multiple common meanings, generate one sentence for the most prevalent meaning and one for the second most prevalent meaning.
2. **Single Meaning**: If the word has only one common meaning, generate only one sentence.
3. **Context**: Ensure the sentences are clear and demonstrate the meaning of the word effectively.
4. **Output Format**: Output ONLY the sentences. Separate them with a newline. Do not include numbering, labels (like "Sentence 1"), or any introductory text.

[Output Pattern]:
<Sentence for meaning 1>
<Sentence for meaning 2 (if applicable)>
`;
    messages.push({ role: "user", content: prompt });
    response = await getCompletionFromMessage(messages);
    console.log("sentences: " + response);
    let sentences = response
      .split("\n")
      .filter((sentence) => sentence.trim() !== "");
    if (document.getElementById("word").innerText !== word) {
      // check whether the same card, due to async
      return;
    }
    document.getElementById("sentences").innerText = sentences.join("\n\n");
    localStorage.setItem("front_text", sentences.join("\n\n"));

    prompt = `
Translate the sentences from English to Chinese. 

**Output Format**: Output ONLY the sentences. Separate them with a newline. Do not include numbering, labels (like "Sentence 1"), or any introductory text.

[Output Pattern]:
<Sentence for meaning 1>
<Sentence for meaning 2 (if applicable)>
`;
    messages.push({ role: "assistant", content: response });
    messages.push({ role: "user", content: prompt });
    response = await getCompletionFromMessage(messages);
    console.log("translations: " + response);
    let translations = response
      .split("\n")
      .filter((sentence) => sentence.trim() !== "");
    let combined = [];
    for (let i = 0; i < sentences.length; i++) {
      combined.push(sentences[i]);
      combined.push(translations[i]);
    }
    localStorage.setItem("front_text", combined.join("\n\n"));

    let clickEvent = () => {
      if (document.getElementById("word").innerText !== word) {
        return;
      }
      document.getElementById("sentences").innerText = combined.join("\n\n");
      document.getElementById("button").remove();
    };

    document.getElementById("button").addEventListener("click", clickEvent);
  }

  // Call the main function to start
  main();
</script>
